<?php

/**
 * @file
 * Message in Fabecook style.
 */

/**
 * Implements hook_theme().
 */
function message_fb_theme(){
  return array(
    'message_fb' =>  array(
      'template' => 'theme/message-fb',
      'render element' => 'entity'
    ),
    'babble__field_comment' =>  array(
      'template' => 'theme/babble--field-comment',
      'render element' => 'babble'
    ),
  );
}

/**
 * Message preprocess.
 */
function message_fb_preprocess_message(&$variables) {
  global $user;

  // Check if we have a Babble field on the Message entity.
  $message = $variables['message'];
  $babble_field = FALSE;
  foreach (field_info_instances('message', $message->type) as $field_name => $instance) {
    $field = field_info_field($field_name);
    if ($field['type'] == 'babble') {
      $babble_field = $field_name;
      break;
    }
  }

  if (!$babble_field) {
    // Not a Babble field.
    return;
  }

  $variables['babble_field'] = $babble_field;
  $variables['theme_hook_suggestions'][] = 'message_fb';

  $babble_body_field = &$variables['content'][$babble_field . '_babble_comment_form']['babble_body'][LANGUAGE_NONE][0]['value'];
  $babble_body_field['#title_display'] = 'invisible';

  // Add HTML5 required.
  $babble_body_field['#attributes']['required'] = 'required';
  $babble_body_field['#attributes']['placeholder'] = t('Write a comment...');

  $account = user_load($user->uid);
  $picture = theme('user_picture', array('account' => $account));
  $babble_body_field['#prefix'] = $picture ? $picture : '';

  // Add assets.
  $babble_body_field['#attached']['css'][] = drupal_get_path('module', 'message_fb') . '/css/message_fb.css';
  $babble_body_field['#attached']['js'][] = drupal_get_path('module', 'message_fb') . '/js/message_fb.js';

  $variables['content'][$babble_field]['#label_display'] = 'hidden';
  $variables['content'][$babble_field . '_babble_comment_form']['#prefix'] = '';
  $variables['content'][$babble_field . '_babble_comment_form']['author']['_name']['#access'] = FALSE;

  // Get the user's picture.
  $account = user_load($message->uid);
  $picture = theme('user_picture', array('account' => $account));
  $variables['user_picture'] = $picture ? $picture : '';
}

/**
 * Babble preprocess.
 */
function message_fb_preprocess_babble(&$variables) {
  $babble = $variables['babble'];
  if ($babble->field_name != 'field_comment') {
    return;
  }
  $time_ago = format_interval(REQUEST_TIME - $babble->created);
  $variables['content']['time_ago'] = array(
    '#markup' => t('@time ago', array('@time' => $time_ago)),
    '#weight' => 99,
  );

  // Get the user's picture.
  $account = user_load($babble->uid);
  $picture = theme('user_picture', array('account' => $account));
  $variables['user_picture'] = $picture ? $picture : '';
}
